<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show-Chat Emoji Edition</title>
    <style>
        :root {
            --bg-darker: #202225; --bg-sidebar: #2f3136; --bg-chat: #36393f;
            --bg-input: #40444b; --text-main: #dcddde; --text-muted: #72767d;
            --accent-blue: #5865f2; --accent-green: #3ba55d; --accent-red: #ed4245;
        }
        body { font-family: sans-serif; margin: 0; background: var(--bg-chat); height: 100dvh; display: flex; color: var(--text-main); overflow: hidden; }
        
        /* Ë™çË®ºÁîªÈù¢ */
        #auth-screen { position: fixed; inset: 0; z-index: 10000; display: flex; align-items: center; justify-content: center; background: var(--bg-darker); }
        .auth-box { background: var(--bg-sidebar); padding: 32px; border-radius: 8px; width: 320px; text-align: center; }
        .auth-input { width: 100%; padding: 10px; margin: 10px 0; background: var(--bg-darker); border: 1px solid #222; color: white; border-radius: 4px; box-sizing: border-box; }
        
        /* „Ç¢„Ç§„Ç≥„É≥ÈÅ∏Êäû */
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 15px 0; }
        .icon-option { 
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; 
            display: flex; align-items: center; justify-content: center; font-size: 20px; background: #444;
        }
        .icon-option.selected { border-color: var(--accent-blue); background: #555; }

        /* „É°„Ç§„É≥ÁîªÈù¢ */
        .sidebar { width: 240px; background: var(--bg-sidebar); display: flex; flex-direction: column; }
        main { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); }
        header { height: 48px; padding: 0 15px; border-bottom: 1px solid #222; display: flex; align-items: center; font-weight: bold; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px 0; }
        .msg-row { display: flex; padding: 8px 20px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; background: #4f545c; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
        
        .input-area { padding: 0 20px 20px; }
        .input-box { background: var(--bg-input); border-radius: 8px; padding: 10px 15px; }
        #chat-input { width: 100%; background: transparent; border: none; color: white; outline: none; font-size: 16px; }

        /* Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ */
        #settings-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
        .modal-card { background: var(--bg-sidebar); width: 320px; border-radius: 8px; padding: 20px; }
        .modal-btn { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 id="auth-title">Show-Chat</h2>
            <div id="auth-error" style="color:var(--accent-red); font-size:12px;"></div>
            <input type="text" id="auth-user" class="auth-input" placeholder="ÂêçÂâç">
            <input type="password" id="auth-pass" class="auth-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ">
            <div id="signup-only" style="display:none;">
                <p style="font-size:11px; color:var(--text-muted);">„Ç¢„Ç§„Ç≥„É≥„ÇíÈÅ∏„Çì„Åß„Å≠</p>
                <div class="icon-grid" id="signup-icon-grid"></div>
            </div>
            <button class="modal-btn" style="background:var(--accent-blue);" id="btn-login">„É≠„Ç∞„Ç§„É≥</button>
            <p style="font-size:12px; cursor:pointer; color:var(--accent-blue);" id="toggle-auth">Êñ∞Ë¶èÁôªÈå≤„ÅØ„Åì„Å°„Çâ</p>
        </div>
    </div>

    <aside class="sidebar">
        <header>Show-Chat</header>
        <div style="flex:1; padding:10px;">
            <div style="color:var(--text-muted); font-size:12px; margin-bottom:10px;">„ÉÅ„É£„É≥„Éç„É´</div>
            <div style="padding:8px; background:#4f545c; border-radius:4px;"># „É°„Ç§„É≥</div>
        </div>
        <div style="padding:10px; background:rgba(0,0,0,0.2); display:flex; align-items:center; gap:10px;">
            <div id="my-avatar" class="avatar" style="width:32px; height:32px; font-size:16px;"></div>
            <div id="my-name" style="flex:1; font-size:14px; font-weight:bold;"></div>
            <div style="cursor:pointer;" id="open-settings">‚öôÔ∏è</div>
        </div>
    </aside>

    <main>
        <header># „É°„Ç§„É≥</header>
        <div id="messages"></div>
        <div class="input-area">
            <div class="input-box"><input type="text" id="chat-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°"></div>
        </div>
    </main>

    <div id="settings-modal">
        <div class="modal-card">
            <h3>Ë®≠ÂÆö</h3>
            <p style="font-size: 12px; color: var(--text-muted);">„Ç¢„Ç§„Ç≥„É≥Â§âÊõ¥:</p>
            <div class="icon-grid" id="settings-icon-grid"></div>
            <button class="modal-btn" style="background:#4f545c; margin-top:10px;" onclick="document.getElementById('settings-modal').style.display='none'">Èñâ„Åò„Çã</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, serverTimestamp, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCVoT10q21bNe7ks6DrLZWkl0JIJ2cIa0s",
        authDomain: "mochimochi-chat8.firebaseapp.com",
        databaseURL: "https://mochimochi-chat8-default-rtdb.firebaseio.com",
        projectId: "mochimochi-chat8",
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = null;
    let selectedEmoji = "üê±";
    const emojis = ["üê±", "üê∂", "ü¶ä", "üêª", "üêº", "ü§ñ", "üëª", "üêØ", "üê∏", "üêß"];

    // „Ç¢„Ç§„Ç≥„É≥ÈÅ∏Êäû„ÅÆ‰ΩúÊàê
    function initGrids() {
        [document.getElementById('signup-icon-grid'), document.getElementById('settings-icon-grid')].forEach(grid => {
            if(!grid) return;
            emojis.forEach(e => {
                const div = document.createElement('div');
                div.className = 'icon-option';
                div.innerText = e;
                div.onclick = () => {
                    selectedEmoji = e;
                    grid.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                    if(currentUser) updateIcon(e);
                };
                grid.appendChild(div);
            });
        });
    }
    initGrids();

    const btnLogin = document.getElementById('btn-login');
    const toggleAuth = document.getElementById('toggle-auth');
    let isSignup = false;

    toggleAuth.onclick = () => {
        isSignup = !isSignup;
        document.getElementById('signup-only').style.display = isSignup ? 'block' : 'none';
        btnLogin.innerText = isSignup ? 'ÁôªÈå≤' : '„É≠„Ç∞„Ç§„É≥';
    };

    btnLogin.onclick = async () => {
        const name = document.getElementById('auth-user').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        if(!name || !pass) return;

        const userRef = ref(db, `users/${name}`);
        const snap = await get(userRef);

        if(isSignup) {
            if(snap.exists()) return alert("„Åù„ÅÆÂêçÂâç„ÅØ‰Ωø„Çè„Çå„Å¶„ÅÑ„Åæ„Åô");
            const userData = { name, pass, icon: selectedEmoji };
            await set(userRef, userData);
            loginSuccess(userData);
        } else {
            if(!snap.exists() || snap.val().pass !== pass) return alert("ÂêçÂâç„Åã„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô");
            loginSuccess(snap.val());
        }
    };

    function loginSuccess(user) {
        currentUser = user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('my-name').innerText = user.name;
        document.getElementById('my-avatar').innerText = user.icon;
        loadMessages();
    }

    async function updateIcon(emoji) {
        await set(ref(db, `users/${currentUser.name}/icon`), emoji);
        currentUser.icon = emoji;
        document.getElementById('my-avatar').innerText = emoji;
    }

    function loadMessages() {
        onValue(ref(db, 'messages/„É°„Ç§„É≥'), (snap) => {
            const box = document.getElementById('messages');
            box.innerHTML = '';
            snap.forEach(c => {
                const m = c.val();
                const div = document.createElement('div');
                div.className = 'msg-row';
                div.innerHTML = `<div class="avatar">${m.icon}</div><div><div style="font-weight:bold;font-size:12px;">${m.name}</div><div>${m.text}</div></div>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    document.getElementById('chat-input').onkeydown = (e) => {
        if(e.key === 'Enter' && e.target.value.trim()) {
            push(ref(db, 'messages/„É°„Ç§„É≥'), {
                name: currentUser.name, text: e.target.value, icon: currentUser.icon, time: serverTimestamp()
            });
            e.target.value = '';
        }
    };

    document.getElementById('open-settings').onclick = () => {
        document.getElementById('settings-modal').style.display = 'flex';
    };
</script>
</body>
</html>
